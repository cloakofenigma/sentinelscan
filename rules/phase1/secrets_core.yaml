# Phase 1 - Core Secret Detection Rules
# High-confidence patterns for detecting hardcoded secrets

metadata:
  name: Secret Detection Core Rules
  description: Detect hardcoded secrets, API keys, and credentials
  version: "1.0.0"
  phase: 1

rules:
  # ============================================================================
  # AWS CREDENTIALS
  # ============================================================================

  - id: SECRET-AWS-001
    name: AWS Access Key ID
    description: AWS Access Key ID detected in source code
    severity: critical
    confidence: high
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - aws
    detection:
      patterns:
        - pattern: '(AKIA|ABIA|ACCA|ASIA)[0-9A-Z]{16}'
    remediation:
      description: Use environment variables or AWS IAM roles
      code_example:
        java: |
          // Use environment variable
          String accessKey = System.getenv("AWS_ACCESS_KEY_ID");

          // Or use IAM role (preferred)
          AmazonS3 s3 = AmazonS3ClientBuilder.defaultClient();
    references:
      - https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html

  - id: SECRET-AWS-002
    name: AWS Secret Access Key
    description: AWS Secret Access Key pattern detected
    severity: critical
    confidence: medium
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - aws
    detection:
      patterns:
        - pattern: "(?i)(aws)?_?secret_?access_?key[\"'\\s:=]+[A-Za-z0-9/+=]{40}"
        - pattern: "[\"'][A-Za-z0-9/+=]{40}[\"']"
          context: aws_config
    remediation:
      description: Use environment variables or AWS Secrets Manager
    references:
      - https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html

  # ============================================================================
  # GITHUB TOKENS
  # ============================================================================

  - id: SECRET-GH-001
    name: GitHub Personal Access Token
    description: GitHub PAT detected
    severity: critical
    confidence: high
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - github
    detection:
      patterns:
        - pattern: 'ghp_[A-Za-z0-9]{36}'
        - pattern: 'gho_[A-Za-z0-9]{36}'
        - pattern: 'ghu_[A-Za-z0-9]{36}'
        - pattern: 'ghs_[A-Za-z0-9]{36}'
        - pattern: 'ghr_[A-Za-z0-9]{36}'
    remediation:
      description: Use GitHub App authentication or environment variables
    references:
      - https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens

  # ============================================================================
  # GOOGLE/GCP
  # ============================================================================

  - id: SECRET-GCP-001
    name: Google API Key
    description: Google API key detected
    severity: high
    confidence: high
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - google
      - gcp
    detection:
      patterns:
        - pattern: 'AIza[0-9A-Za-z_-]{35}'
    remediation:
      description: Use environment variables and restrict API key usage
    references:
      - https://cloud.google.com/docs/authentication/api-keys

  - id: SECRET-GCP-002
    name: Google OAuth Client Secret
    description: Google OAuth client secret detected
    severity: critical
    confidence: medium
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - google
      - oauth
    detection:
      patterns:
        - pattern: "(?i)client_secret[\"'\\s:=]+[A-Za-z0-9_-]{24}"
    remediation:
      description: Store client secrets in secure configuration
    references:
      - https://developers.google.com/identity/protocols/oauth2

  # ============================================================================
  # STRIPE
  # ============================================================================

  - id: SECRET-STRIPE-001
    name: Stripe API Key
    description: Stripe API key detected
    severity: critical
    confidence: high
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - stripe
      - payment
    detection:
      patterns:
        - pattern: 'sk_live_[0-9a-zA-Z]{24,}'
        - pattern: 'sk_test_[0-9a-zA-Z]{24,}'
        - pattern: 'rk_live_[0-9a-zA-Z]{24,}'
        - pattern: 'rk_test_[0-9a-zA-Z]{24,}'
    remediation:
      description: Store Stripe keys in environment variables or secret manager
    references:
      - https://stripe.com/docs/keys

  # ============================================================================
  # JWT/AUTH
  # ============================================================================

  - id: SECRET-JWT-001
    name: JWT Secret Key
    description: JWT secret or signing key in source code
    severity: high
    confidence: medium
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - jwt
    detection:
      patterns:
        - pattern: "(?i)(jwt|token)[_-]?(secret|key)[\"'\\s:=]+.{20,}"
        - pattern: "(?i)secret[_-]?key[\"'\\s:=]+.{32,}"
    remediation:
      description: Store JWT secrets in environment variables
      code_example:
        java: |
          // Bad
          String secret = "my-super-secret-jwt-key-12345";

          // Good
          String secret = System.getenv("JWT_SECRET");
    references:
      - https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html

  # ============================================================================
  # DATABASE
  # ============================================================================

  - id: SECRET-DB-001
    name: Database Connection String with Password
    description: Database URL containing embedded password
    severity: critical
    confidence: high
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - database
    detection:
      patterns:
        - pattern: '(?i)(jdbc|mysql|postgresql|mongodb|redis)://[^:]+:[^@]+@'
        - pattern: '(?i)mongodb\+srv://[^:]+:[^@]+@'
        - pattern: '(?i)postgres://[^:]+:[^@]+@'
    remediation:
      description: Use environment variables for database credentials
      code_example:
        properties: |
          # Bad
          spring.datasource.url=jdbc:mysql://user:password@localhost/db

          # Good
          spring.datasource.url=jdbc:mysql://localhost/db
          spring.datasource.username=${DB_USER}
          spring.datasource.password=${DB_PASSWORD}
    references:
      - https://cheatsheetseries.owasp.org/cheatsheets/Database_Security_Cheat_Sheet.html

  - id: SECRET-DB-002
    name: Hardcoded Database Password
    description: Database password hardcoded in configuration
    severity: critical
    confidence: medium
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - database
    detection:
      patterns:
        - pattern: "(?i)(datasource|database|db)[._-]?password[\"'\\s:=]+[^$\\{].+"
        - pattern: "(?i)spring\\.datasource\\.password\\s*=\\s*[^$\\{]"
    remediation:
      description: Use environment variables or secrets manager
    references:
      - https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config

  # ============================================================================
  # PRIVATE KEYS
  # ============================================================================

  - id: SECRET-KEY-001
    name: RSA Private Key
    description: RSA private key in source code
    severity: critical
    confidence: high
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - private-key
    detection:
      patterns:
        - pattern: '-----BEGIN RSA PRIVATE KEY-----'
        - pattern: '-----BEGIN PRIVATE KEY-----'
        - pattern: '-----BEGIN EC PRIVATE KEY-----'
        - pattern: '-----BEGIN OPENSSH PRIVATE KEY-----'
    remediation:
      description: Store private keys in secure key management systems
    references:
      - https://cheatsheetseries.owasp.org/cheatsheets/Key_Management_Cheat_Sheet.html

  # ============================================================================
  # SLACK/DISCORD
  # ============================================================================

  - id: SECRET-SLACK-001
    name: Slack Token
    description: Slack bot or user token detected
    severity: high
    confidence: high
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - slack
    detection:
      patterns:
        - pattern: 'xox[baprs]-[0-9]{10,13}-[0-9]{10,13}[a-zA-Z0-9-]*'
    remediation:
      description: Store Slack tokens in environment variables
    references:
      - https://api.slack.com/authentication/token-types

  - id: SECRET-SLACK-002
    name: Slack Webhook URL
    description: Slack webhook URL detected
    severity: medium
    confidence: high
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - slack
      - webhook
    detection:
      patterns:
        - pattern: 'https://hooks\.slack\.com/services/T[A-Z0-9]+/B[A-Z0-9]+/[a-zA-Z0-9]+'
    remediation:
      description: Store webhook URLs in environment variables
    references:
      - https://api.slack.com/messaging/webhooks

  - id: SECRET-DISCORD-001
    name: Discord Webhook URL
    description: Discord webhook URL detected
    severity: medium
    confidence: high
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - discord
      - webhook
    detection:
      patterns:
        - pattern: 'https://discord(app)?\.com/api/webhooks/[0-9]+/[A-Za-z0-9_-]+'
    remediation:
      description: Store webhook URLs in environment variables
    references:
      - https://discord.com/developers/docs/resources/webhook

  # ============================================================================
  # GENERIC PATTERNS
  # ============================================================================

  - id: SECRET-GENERIC-001
    name: Generic API Key Pattern
    description: Potential API key detected
    severity: medium
    confidence: medium
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - api-key
    detection:
      patterns:
        - pattern: "(?i)(api[_-]?key|apikey)[\"'\\s:=]+[a-zA-Z0-9]{20,}"
        - pattern: "(?i)(access[_-]?token|accesstoken)[\"'\\s:=]+[a-zA-Z0-9]{20,}"
    remediation:
      description: Store API keys in environment variables or secret managers
    references:
      - https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html

  - id: SECRET-GENERIC-002
    name: Generic Password Assignment
    description: Potential password hardcoded in code
    severity: high
    confidence: medium
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - password
    detection:
      patterns:
        - pattern: "(?i)(password|passwd|pwd)[\"'\\s:=]+[^$\\{].{8,}"
    remediation:
      description: Never hardcode passwords, use environment variables
    references:
      - https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html

  - id: SECRET-GENERIC-003
    name: Base64 Encoded Secret
    description: Potential base64 encoded secret detected
    severity: medium
    confidence: low
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - base64
    detection:
      patterns:
        - pattern: "(?i)(secret|password|token|key)_?base64[\"'\\s:=]+[A-Za-z0-9+/=]{40,}"
    remediation:
      description: Store secrets securely, not as encoded strings in code
    references:
      - https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html

  # ============================================================================
  # OKTA/AUTH0
  # ============================================================================

  - id: SECRET-OKTA-001
    name: Okta API Token
    description: Okta API token detected
    severity: critical
    confidence: high
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - okta
    detection:
      patterns:
        - pattern: '00[a-zA-Z0-9_-]{40}'
          context: okta
    remediation:
      description: Store Okta tokens in environment variables
    references:
      - https://developer.okta.com/docs/guides/create-an-api-token/

  - id: SECRET-AUTH0-001
    name: Auth0 Client Secret
    description: Auth0 client secret detected
    severity: critical
    confidence: medium
    cwe: CWE-798
    owasp: A02
    tags:
      - secret
      - credentials
      - auth0
    detection:
      patterns:
        - pattern: "(?i)auth0[._-]?(client[._-]?)?secret[\"'\\s:=]+[a-zA-Z0-9_-]{32,}"
    remediation:
      description: Store Auth0 secrets in environment variables
    references:
      - https://auth0.com/docs/secure/security-guidance/data-security/client-credentials
